{% extends 'base.html' %}
{% block content %}
{% load custom_filters %}

<div class="max-w-3xl mx-auto p-6 bg-white shadow-lg rounded-lg mt-10">
    <h1 class="text-3xl font-bold text-gray-800 mb-4 text-center">Checkout</h1>
    
    <p class="text-xl text-gray-700 font-semibold text-center mb-6">
        Total Amount: <strong class="text-green-600">Rs {{ total_price }}</strong>
    </p>

    <form id="checkout-form" action="{% url 'payment_success' %}" method="POST" class="space-y-4">
        {% csrf_token %}
        
        <div>
            <label for="address" class="block text-gray-700 font-medium mb-1">Address:</label>
            <textarea id="address" name="address" required placeholder="room no, wing, building, road, landmark, city, district, pincode"
                class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"></textarea>
        </div>

        <div>
            <label for="phone" class="block text-gray-700 font-medium mb-1">Phone Number:</label>
            <input type="tel" id="phone" name="phone" required
    pattern="[0-9]{10}" maxlength="10"
    class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">

        </div>

        <div>
            <label for="phone" class="block text-gray-700 font-medium mb-1">UPI ID:</label>
            <input type="text" id="upi_id" name="upi_id" required
            placeholder="example@upi"
            class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
        
        </div>

        <div class="flex justify-center">
            <button type="button" id="pay-now" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow hover:bg-green-700 transition">
                Pay Now
            </button>
        </div>
    </form>
</div>

<!-- Razorpay Script -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    const payNowBtn = document.getElementById("pay-now");
    const phoneInput = document.getElementById("phone");
    const upiInput = document.getElementById("upi_id");

    function validateForm() {
        const phoneValid = /^\d{10}$/.test(phoneInput.value.trim());
        const upiValid = /^[\w.-]+@[\w.-]+$/.test(upiInput.value.trim());

        if (phoneValid && upiValid) {
            payNowBtn.disabled = false;
            payNowBtn.classList.remove("opacity-50", "cursor-not-allowed");
        } else {
            payNowBtn.disabled = true;
            payNowBtn.classList.add("opacity-50", "cursor-not-allowed");
        }
    }

    // Initial state
    payNowBtn.disabled = true;
    payNowBtn.classList.add("opacity-50", "cursor-not-allowed");

    // Listen to input events
    phoneInput.addEventListener("input", validateForm);
    upiInput.addEventListener("input", validateForm);

    // Razorpay payment integration
    payNowBtn.addEventListener("click", function () {
        var options = {
            "key": "{{ razorpay_key }}",
            "amount": "{{ total_price|floatformat:2|mul:100 }}",
            "currency": "INR",
            "name": "Farming Grow",
            "description": "Order Payment",
            "order_id": "{{ order_id }}",
            "theme": { "color": "#F37254" },
            "handler": function (response) {
                var form = document.getElementById("checkout-form");
                var input = document.createElement("input");
                input.type = "hidden";
                input.name = "razorpay_payment_id";
                input.value = response.razorpay_payment_id;
                form.appendChild(input);
                form.submit();
            }
        };

        var rzp = new Razorpay(options);
        rzp.open();
    });
</script>

{% endblock %}
